services:
  dns:
    image: jpillora/dnsmasq:latest
    container_name: shadybridge-dns
    restart: unless-stopped
    command:
      - "--no-resolv"
      - "--server=9.9.9.9"
      - "--server=1.1.1.1"
      - "--addn-hosts=/etc/dnsmasq.d/dns-hosts"
      - "--log-facility=-"
    volumes:
      - ./dnsmasq.d:/etc/dnsmasq.d:ro
    healthcheck:
      test: ["CMD-SHELL", "nslookup www.google.com 127.0.0.1 >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    networks:
      shadybridge:
        ipv4_address: 172.30.0.2

  dante:
    build:
      context: .
      dockerfile: Dockerfile-dante
    container_name: shadybridge-dante
    restart: unless-stopped
    ports:
      - "1080:1080"
    dns:
      - 172.30.0.2
    environment:
      # Optional: tighten LAN access or tweak runtime opts
      - DANTED_EXTERNAL=eth0         # if you want to pin it
      - DANTED_USER=nobody           # or "dante" if you add the user in Dockerfile-dante
      - ALLOW_FROM=0.0.0.0/0
    healthcheck:
      test: ["CMD", "sh", "-lc", "nc -z 127.0.0.1 1080"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    depends_on:
      - nginx
      - dns
    networks:
      - shadybridge

  nginx:
    build:
      context: .
      dockerfile: Dockerfile-nginx
    container_name: shadybridge-nginx
    restart: unless-stopped
    volumes:
      - ./conf-nginx:/etc/nginx/conf.d:ro
    healthcheck:
      test: ["CMD-SHELL", "nginx -t || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    networks:
      shadybridge:
        ipv4_address: 172.30.0.3

  ca-host:
    image: nginx:alpine
    container_name: shadybridge-ca-host
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./www:/usr/share/nginx/html
      - ./certs:/usr/share/nginx/html/certs:ro
    networks:
      - shadybridge

networks:
  shadybridge:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/29